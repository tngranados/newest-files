name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.4"
          bundler-cache: true

      - name: Install dependencies
        run: bundle install

      - name: Run tests
        run: bundle exec rake test

      - name: Build gem
        run: gem build newest_files.gemspec

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: newest_files-${{ steps.get_version.outputs.VERSION }}.gem
          generate_release_notes: true

      - name: Calculate SHA256 of tarball
        id: sha256
        run: |
          SHA=$(curl -sL "https://github.com/${{ github.repository }}/archive/refs/tags/v${{ steps.get_version.outputs.VERSION }}.tar.gz" | shasum -a 256 | cut -d ' ' -f 1)
          echo "SHA256=$SHA" >> $GITHUB_OUTPUT

      - name: Update Homebrew formula
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          SHA256="${{ steps.sha256.outputs.SHA256 }}"

          # Update version in formula URL
          sed -i "s|archive/refs/tags/v[0-9.]*\.tar\.gz|archive/refs/tags/v${VERSION}.tar.gz|g" Formula/newest-files.rb

          # Update sha256 in formula
          awk -v sha="$SHA256" '
            /^  sha256/ && !replaced {
              print "  sha256 \047" sha "\047"
              replaced = 1
              next
            }
            { print }
          ' Formula/newest-files.rb > Formula/newest-files.rb.tmp && mv Formula/newest-files.rb.tmp Formula/newest-files.rb

          cat Formula/newest-files.rb

      - name: Commit updated formula
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/newest-files.rb
          git commit -m "Update Homebrew formula for v${{ steps.get_version.outputs.VERSION }}" || echo "No changes to commit"
          git push origin main
